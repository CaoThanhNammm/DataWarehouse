<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đọc file Excel khi bấm nút</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
    <!-- Input để chọn file -->
    <input type="file" id="excelInput" />
    <!-- Nút để bấm đọc file -->
    <button id="readButton">Đọc file Excel</button>
    <!-- Khu vực hiển thị kết quả -->
    <pre id="output"></pre>

    <script>
        function excelDateToLocalDateTime(excelDate) {
            // Bước 1: Tính ngày từ phần nguyên
            const daysSinceExcelStart = Math.floor(excelDate); // Lấy phần nguyên
            const startDate = new Date(Date.UTC(1899, 11, 30)); // Ngày bắt đầu: 30/12/1899
        
            // Cộng số ngày vào
            startDate.setUTCDate(startDate.getUTCDate() + daysSinceExcelStart);
        
            // Bước 2: Tính giờ từ phần thập phân
            const fractionalPart = excelDate - daysSinceExcelStart; // Phần thập phân
            const totalSecondsInDay = 24 * 60 * 60; // Tổng giây trong một ngày
        
            // Tính giờ, phút, giây
            const totalSeconds = Math.round(fractionalPart * totalSecondsInDay);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
        
            // Cộng thời gian vào ngày
            startDate.setUTCHours(startDate.getUTCHours() + hours);
            startDate.setUTCMinutes(startDate.getUTCMinutes() + minutes);
            startDate.setUTCSeconds(startDate.getUTCSeconds() + seconds);
        
            return startDate;
        }

        let selectedFile = null;

        // Lưu trữ file được chọn
        document.getElementById('excelInput').addEventListener('change', function (event) {
            selectedFile = event.target.files[0]; // Lưu file khi chọn
        });

        // Khi bấm nút, đọc và hiển thị file Excel
        document.getElementById('readButton').addEventListener('click', function () {
            if (selectedFile) {
                const reader = new FileReader();

                // Đọc file dưới dạng binary
                reader.readAsBinaryString(selectedFile);

                reader.onload = function (event) {
                    const data = event.target.result;

                    // Đọc file Excel bằng SheetJS
                    const workbook = XLSX.read(data, { type: 'binary' });

                    // Lấy sheet đầu tiên
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];

                    // Chuyển đổi sheet sang JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    jsonData.forEach(function (key, index) {
                        var id = key[0]
                        if (id === -1) {
                            id = " "
                        }
                        const name = key[1]
                        const price = key[2]
                        const price_sale = key[3]
                        const brand = key[4]
                        const color = key[5]
                        const size = key[6]
                        const status = key[7]
                        const timeStartScrape = excelDateToLocalDateTime(key[8])
                        const timeEndScrape = excelDateToLocalDateTime(key[9])

                        const bikeJson = {
                            "id": id,
                            "name": name,
                            "price": price,
                            "priceSale": price_sale,
                            "brand": brand,
                            "color": color,
                            "size": size,
                            "status": status,
                            "timeStartScrape": timeStartScrape,
                            "timeEndScrape": timeEndScrape
                        }

                        console.log(bikeJson)
                        fetch('http://localhost:8080/api/bike/save', { // Thay đổi port nếu cần
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(bikeJson),
                        })
                            .then(response => response.json())
                            .then(data => {
                                document.getElementById('output').innerText = JSON.stringify(data, null, 2);
                            })
                            .catch(error => {
                                console.error('Error:', error);
                            });
                    })
                };

                reader.onerror = function (error) {
                    console.error('Lỗi khi đọc file:', error);
                };
            } else {
                alert('Vui lòng chọn file trước!');
            }
        });
    </script>
</body>

</html>